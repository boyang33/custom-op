# TensorSplitByOffsets è‡ªå®šä¹‰ç®—å­

## æ¦‚è¿°

`TensorSplitByOffsets` æ˜¯ä¸€ä¸ªé«˜æ€§èƒ½çš„TensorFlowè‡ªå®šä¹‰ç®—å­ï¼Œç”¨äºå°†å¤šç»´tensoræ²¿ç¬¬0ç»´æŒ‰æŒ‡å®šåç§»é‡æ‹†åˆ†ä¸ºå¤šä¸ªè¾“å‡ºtensorã€‚è¯¥ç®—å­æ”¯æŒCPUå’ŒGPUè®¾å¤‡ï¼Œå¹¶é’ˆå¯¹ä¸åŒåœºæ™¯è¿›è¡Œäº†ä¼˜åŒ–ã€‚

## ä¸»è¦ç‰¹æ€§

### ğŸš€ é«˜æ€§èƒ½è®¾è®¡
- **CPUç‰ˆæœ¬**: æ”¯æŒé›¶æ‹·è´ä¼˜åŒ–ï¼Œä½¿ç”¨é«˜æ•ˆçš„å†…å­˜å¤åˆ¶æ“ä½œ
- **GPUç‰ˆæœ¬**: é‡‡ç”¨é«˜æ•ˆå¹¶è¡Œå¤„ç†ï¼Œæœ€å¤§åŒ–å†…å­˜å¸¦å®½åˆ©ç”¨ç‡
- **è‡ªé€‚åº”ç­–ç•¥**: æ ¹æ®æ•°æ®ç‰¹å¾è‡ªåŠ¨é€‰æ‹©æœ€ä¼˜çš„å¤„ç†æ–¹å¼

### ğŸ”§ åŠŸèƒ½ç‰¹ç‚¹
- **å¤šç»´tensoræ”¯æŒ**: å¤„ç†ä»»æ„ç»´åº¦çš„tensorï¼ˆâ‰¥1ç»´ï¼‰
- **çµæ´»æ‹†åˆ†**: åŸºäºåç§»é‡ä¿¡æ¯è¿›è¡Œç²¾ç¡®çš„åŒºé—´æ‹†åˆ†
- **å†…å­˜ä¼˜åŒ–**: æ™ºèƒ½çš„å†…å­˜å¯¹é½æ£€æŸ¥å’Œé›¶æ‹·è´ä¼˜åŒ–
- **é”™è¯¯å¤„ç†**: å®Œæ•´çš„è¾¹ç•Œæ£€æŸ¥å’Œå¼‚å¸¸å¤„ç†æœºåˆ¶

### âš¡ æ€§èƒ½ä¼˜åŒ–
- **GPUå¹¶è¡Œå¤„ç†**: å……åˆ†åˆ©ç”¨GPUå¤šæ ¸å¹¶è¡Œè®¡ç®—èƒ½åŠ›
- **å‘é‡åŒ–å†…å­˜è®¿é—®**: ä¼˜åŒ–çš„å†…å­˜å¤åˆ¶æ¨¡å¼
- **å¼‚æ­¥æ“ä½œ**: ä½¿ç”¨CUDAæµè¿›è¡Œå¼‚æ­¥å†…å­˜ä¼ è¾“
- **èµ„æºç®¡ç†**: è‡ªåŠ¨çš„GPUå†…å­˜åˆ†é…å’Œé‡Šæ”¾

## ä½¿ç”¨æ–¹æ³•

### åŸºæœ¬ç”¨æ³•

```python
import tensorflow as tf
from tensor_split_by_offsets.python.ops import tensor_split_by_offsets_ops

# åˆ›å»ºè¾“å…¥tensor [6, 3]
input_tensor = tf.constant([
    [1, 2, 3], 
    [4, 5, 6], 
    [7, 8, 9], 
    [10, 11, 12], 
    [13, 14, 15], 
    [16, 17, 18]
])

# å®šä¹‰åç§»é‡ï¼š[start, length] æ ¼å¼
offsets = tf.constant([
    [0, 2],  # å–å‰2è¡Œ: [[1,2,3], [4,5,6]]
    [2, 3],  # å–æ¥ä¸‹æ¥3è¡Œ: [[7,8,9], [10,11,12], [13,14,15]]
    [5, 1]   # å–æœ€å1è¡Œ: [[16,17,18]]
], dtype=tf.int32)

# æ‰§è¡Œæ‹†åˆ†
outputs = tensor_split_by_offsets_ops.tensor_split_by_offsets(input_tensor, offsets)

print(f"è¾“å‡ºæ•°é‡: {len(outputs)}")
print(f"è¾“å‡º0å½¢çŠ¶: {outputs[0].shape}")  # [2, 3]
print(f"è¾“å‡º1å½¢çŠ¶: {outputs[1].shape}")  # [3, 3]
print(f"è¾“å‡º2å½¢çŠ¶: {outputs[2].shape}")  # [1, 3]
```

### é«˜ç»´tensorç¤ºä¾‹

```python
# 4ç»´tensorç¤ºä¾‹ [total_samples, height, width, channels]
input_4d = tf.random.normal([10, 32, 32, 64])

# æ²¿ç¬¬0ç»´æ‹†åˆ†
offsets_4d = tf.constant([
    [0, 3],   # å‰3ä¸ªæ ·æœ¬
    [3, 4],   # ä¸­é—´4ä¸ªæ ·æœ¬  
    [7, 3]    # æœ€å3ä¸ªæ ·æœ¬
], dtype=tf.int32)

outputs_4d = tensor_split_by_offsets_ops.tensor_split_by_offsets(input_4d, offsets_4d)
# è¾“å‡ºå½¢çŠ¶: [3, 32, 32, 64], [4, 32, 32, 64], [3, 32, 32, 64]
```

### GPUåŠ é€Ÿä½¿ç”¨

```python
# æŒ‡å®šåœ¨GPUä¸Šæ‰§è¡Œ
with tf.device('/GPU:0'):
    input_tensor = tf.constant([[1, 2], [3, 4], [5, 6]], dtype=tf.float32)
    offsets = tf.constant([[0, 2], [2, 1]], dtype=tf.int32)
    
    outputs = tensor_split_by_offsets_ops.tensor_split_by_offsets(input_tensor, offsets)
```

## ç®—æ³•åŸç†

### CPUå®ç°
1. **é›¶æ‹·è´æ£€æŸ¥**: æ£€æŸ¥å†…å­˜å¯¹é½å’Œåˆ‡ç‰‡å¤§å°ï¼Œå†³å®šæ˜¯å¦ä½¿ç”¨é›¶æ‹·è´
2. **å†…å­˜å¤åˆ¶**: å¯¹éœ€è¦å¤åˆ¶çš„æ•°æ®ä½¿ç”¨`std::memcpy`è¿›è¡Œé«˜æ•ˆå¤åˆ¶
3. **è¾¹ç•ŒéªŒè¯**: ç¡®ä¿æ‰€æœ‰è®¿é—®éƒ½åœ¨æœ‰æ•ˆèŒƒå›´å†…

### GPUå®ç°
1. **å¹¶è¡Œå¤„ç†**: åˆ©ç”¨GPUå¤šæ ¸å¹¶è¡Œè®¡ç®—èƒ½åŠ›
2. **é«˜æ•ˆå†…å­˜è®¿é—®**: ä¼˜åŒ–çš„å†…å­˜è®¿é—®æ¨¡å¼
3. **å‘é‡åŒ–å¤åˆ¶**: ä½¿ç”¨å¾ªç¯å±•å¼€ä¼˜åŒ–å†…å­˜è®¿é—®
4. **èµ„æºæ¸…ç†**: è‡ªåŠ¨é‡Šæ”¾GPUå†…å­˜èµ„æº

## æ€§èƒ½ç‰¹å¾

### æ—¶é—´å¤æ‚åº¦
- **CPU**: O(æ€»å¤åˆ¶å…ƒç´ æ•°) 
- **GPU**: O(æ€»è¡Œæ•° / GPUæ ¸å¿ƒæ•°)

### ç©ºé—´å¤æ‚åº¦
- **CPU**: O(1) é¢å¤–ç©ºé—´ï¼ˆé›¶æ‹·è´æ—¶ï¼‰
- **GPU**: O(1) é¢å¤–è®¾å¤‡å†…å­˜ï¼ˆä¸è®¡ç®—è¾“å‡ºï¼‰

### ä¼˜åŒ–ç­–ç•¥
- **å¤§tensor**: è‡ªåŠ¨é€‰æ‹©é›¶æ‹·è´æˆ–å¹¶è¡Œå¤„ç†
- **å°tensor**: é«˜æ•ˆçš„å¹¶è¡Œå¤„ç†
- **å†…å­˜å¯¹é½**: åˆ©ç”¨EIGENå¯¹é½è¦æ±‚ä¼˜åŒ–è®¿é—®

## ç¼–è¯‘å’Œæ„å»º

```bash
# ä½¿ç”¨Bazelæ„å»º
bazel build //tensor_split_by_offsets:tensor_split_by_offsets_ops

# è¿è¡Œæµ‹è¯•
bazel test //tensor_split_by_offsets:tensor_split_by_offsets_ops_py_test
```

### ä¾èµ–è¦æ±‚
- TensorFlow >= 2.0
- CUDA >= 10.0 (GPUç‰ˆæœ¬)
- Bazelæ„å»ºç³»ç»Ÿ

## APIå‚è€ƒ

### tensor_split_by_offsets(input_tensor, offsets, name=None)

**å‚æ•°:**
- `input_tensor`: è‡³å°‘1ç»´çš„è¾“å…¥Tensor
- `offsets`: å½¢çŠ¶ä¸º[N, 2]çš„int32 Tensorï¼Œæ¯è¡Œä¸º[start, length]
- `name`: æ“ä½œåç§°ï¼ˆå¯é€‰ï¼‰

**è¿”å›:**
- Tensoråˆ—è¡¨ï¼Œæ¯ä¸ªå¯¹åº”ä¸€ä¸ªæ‹†åˆ†çš„è¾“å‡º

**å¼‚å¸¸:**
- `ValueError`: è¾“å…¥ç»´åº¦ä¸è¶³æˆ–åç§»é‡æ ¼å¼é”™è¯¯
- `InvalidArgument`: è¾¹ç•Œæ£€æŸ¥å¤±è´¥æˆ–åç§»é‡è¶…å‡ºèŒƒå›´

## æ¢¯åº¦æ”¯æŒ

ç®—å­æ”¯æŒè‡ªåŠ¨æ¢¯åº¦è®¡ç®—ï¼Œåå‘ä¼ æ’­æ—¶ä¼šå°†è¾“å‡ºæ¢¯åº¦æ­£ç¡®åˆå¹¶å›è¾“å…¥æ¢¯åº¦çš„å¯¹åº”ä½ç½®ã€‚

```python
# æ¢¯åº¦è®¡ç®—ç¤ºä¾‹
with tf.GradientTape() as tape:
    tape.watch(input_tensor)
    outputs = tensor_split_by_offsets_ops.tensor_split_by_offsets(input_tensor, offsets)
    loss = tf.reduce_sum([tf.reduce_sum(out) for out in outputs])

gradients = tape.gradient(loss, input_tensor)
```

## æœ€ä½³å®è·µ

1. **å†…å­˜å¯¹é½**: ç¡®ä¿è¾“å…¥tensorå†…å­˜å¯¹é½ä»¥è·å¾—æœ€ä½³æ€§èƒ½
2. **åˆ‡ç‰‡å¤§å°**: å¤§åˆ‡ç‰‡æ›´é€‚åˆé›¶æ‹·è´ä¼˜åŒ–
3. **GPUä½¿ç”¨**: å¯¹äºå¤§å‹tensorï¼ŒGPUç‰ˆæœ¬é€šå¸¸æ€§èƒ½æ›´å¥½
4. **æ‰¹å¤„ç†**: å°½é‡æ‰¹é‡å¤„ç†å¤šä¸ªæ‹†åˆ†æ“ä½œ

## æ•…éšœæ’é™¤

### å¸¸è§é”™è¯¯
- **CUDA_ERROR_ILLEGAL_ADDRESS**: æ£€æŸ¥GPUå†…å­˜å’Œåç§»é‡æœ‰æ•ˆæ€§
- **è¾¹ç•Œæ£€æŸ¥å¤±è´¥**: ç¡®ä¿offsetsä¸è¶…å‡ºè¾“å…¥tensorèŒƒå›´
- **å½¢çŠ¶ä¸åŒ¹é…**: éªŒè¯offsets tensorçš„å½¢çŠ¶ä¸º[N, 2]

### è°ƒè¯•å»ºè®®
- ä½¿ç”¨è¾ƒå°çš„æµ‹è¯•æ•°æ®éªŒè¯é€»è¾‘
- æ£€æŸ¥offsetsçš„æœ‰æ•ˆæ€§å’Œè¾¹ç•Œ
- ç¡®è®¤GPUå†…å­˜å……è¶³

## è®¸å¯è¯

Copyright 2017 The TensorFlow Authors. All Rights Reserved.

Licensed under the Apache License, Version 2.0.